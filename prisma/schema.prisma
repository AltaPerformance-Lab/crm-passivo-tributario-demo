generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Definição dos ENUMS
enum Role {
  ADMIN
  USER
}

enum LeadStatus {
  A_VERIFICAR
  VERIFICADO
  CONTATADO
  AGUARDANDO_RESPOSTA
  EM_NEGOCIACAO
  NAO_TEM_INTERESSE
  CONVERTIDO
  DESCARTADO
}


// --- MODELOS PRINCIPAIS ---

model User {
  id           String         @id @default(cuid())
  name         String?
  email        String?        @unique
  password     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  role         Role           @default(USER)
  
  // Relações
  leads        Lead[]
  negocios     Negocio[]
  configuracao Configuracao?
}

model Lead {
  id               String     @id @default(cuid())
  cnpj             String
  nomeDevedor      String
  nomeFantasia     String?
  valorTotalDivida Float
  status           LeadStatus @default(A_VERIFICAR)
  municipio        String?    // Campo usado no filtro
  uf               String?    // Campo usado no filtro
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  // Relações
  userId           String
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  empresaId        Int?       @unique
  empresa          Empresa?   @relation(fields: [empresaId], references: [id], onUpdate: NoAction, onDelete: SetNull)

  negocio          Negocio?
  atividades       Atividade[]
  lembretes        Lembrete[]
  
  // Índices e Constraints
  @@unique([cnpj, userId])
  @@index([userId])
  @@index([nomeDevedor])
  @@index([municipio])
  @@index([status])
}

model Negocio {
  id                String     @id @default(cuid())
  valorFechado      Float
  valorEscritorio   Float      @default(0)
  valorOutraParte   Float
  valorRecebido     Float
  dataFechamento    DateTime   @default(now())
  
  // Relações
  lead              Lead       @relation(fields: [leadId], references: [id])
  leadId            String     @unique
  
  userId            String
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  propostas         Proposta[]

  // Índices
  @@index([userId])
}

model Proposta {
  id             String    @id @default(cuid())
  objeto         String?
  escopo         String?   @db.Text
  valores        String?   @db.Text
  validade       DateTime?
  nomeArquivo    String?
  caminhoArquivo String
  createdAt      DateTime  @default(now())
  
  // Relações
  negocio        Negocio   @relation(fields: [negocioId], references: [id], onDelete: Cascade)
  negocioId      String
}


// --- MODELOS DE SUPORTE ---

model Configuracao {
  id          String  @id @default(cuid())
  nomeEmpresa String?
  cnpj        String?
  endereco    String?
  email       String?
  telefone    String?
  logoUrl     String?

  // Relações
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Índices
  @@index([userId])
}

model Atividade {
  id        String   @id @default(cuid())
  conteudo  String   @db.Text
  criadoEm  DateTime @default(now())
  
  // Relações
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
}

model Lembrete {
  id        String   @id @default(cuid())
  data      DateTime
  descricao String
  concluido Boolean  @default(false)
  criadoEm  DateTime @default(now())
  
  // Relações
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId    String
}


// --- MODELOS DE ENRIQUECIMENTO (DADOS EXTERNOS) ---
// Estes modelos não precisam de relação com User.

model Empresa {
  id                      Int       @id @default(autoincrement())
  cnpj                    String    @unique
  razaoSocial             String
  nomeFantasia            String?
  situacaoCadastral       String
  dataSituacaoCadastral   String?
  logradouro              String?
  numero                  String?
  bairro                  String?
  cep                     String?
  municipio               String?
  uf                      String?
  capitalSocial           Float?
  telefone                String?
  porte                   String?
  naturezaJuridica        String?
  cnaeFiscalDescricao     String?
  dataInicioAtividade     String?
  regimeTributario        String?
  cnaesSecundarios        Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  // Relações
  socios                  Socio[]
  contatos                Contato[]
  lead                    Lead?
}

model Socio {
  id                     Int      @id @default(autoincrement())
  nomeSocio              String
  qualificacaoSocio      String
  dataEntradaSociedade   String?
  documento              String?

  // Relações
  empresa                Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId              Int
}

model Contato {
  id         Int      @id @default(autoincrement())
  nome       String
  cargo      String?
  telefone   String?
  email      String?
  observacao String?
  createdAt  DateTime @default(now())

  // Relações
  empresa    Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId  Int
}